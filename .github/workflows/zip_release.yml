# This workflow will build geo-11 for Release use.
# This is a basic workflow that will only be manually triggered.
# This is used to verify builds are successful, and for testing. Build Version will
# be incremented for every build, and committed back to the repo.
#
# To make a new Release, Tag a successful build, and the release_on_tag.yml will run.

name: HelixMod Manual Build

# Controls when the action will run. Workflow runs when manually triggered using the UI.
on:
  workflow_dispatch:
    # Inputs the workflow accepts.
    inputs:
      name:
        # Friendly description to be shown in the UI instead of 'name'
        description: 'Create ZipRelease for HelixMod use'
        # Default value if no value is explicitly provided
        default: 'World'
        # Input has to be provided for the workflow to run
        required: true

# This is a copy of the msbuild.yml action script. The setup to
# call out to another job is too restrictive, so let's just duplicate
# the sequence, but upload different artifact here.

jobs:
  zip_release_workflow:

    # Now runs on latest runners with VS2022 as default.
    runs-on: windows-2022

    steps:
    - name: Checkout branch vs2022
      uses: actions/checkout@v4
      with:
        ref: vs2022  

    - name: Show all Visual Studio installs
      shell: cmd
      run: |
        "C:\Program Files (x86)\Microsoft Visual Studio\Installer\vswhere.exe" -all
        echo(
        echo === Installed VS ===
        dir "C:\Program Files (x86)\Microsoft Visual Studio"
        dir "C:\Program Files\Microsoft Visual Studio"
        echo(
        echo === Installed toolsets ===
        dir "C:\Program Files (x86)\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC"
        dir "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC"
          
    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2
      
# VisualStudio2022 should be there in 'windows-latest'       
#      with:
#        vs-version: '2022'

    - name: Build via Publish.bat
      shell: cmd
      run: call .\Publish.bat 

# In order to pass the version number from the Publish.bat script back here to Actions,
# we need to fetch it using powershell commands. Normal echo and cat don't work here.
# Fetches the version from the embedded version file name.
# It's also worth noting that the env.GITHUB_ENV is only read at the start of a Step,
# so the variable will be wrong until the next step.

    - name: Versioning
      shell: pwsh
      run: |
        cat ".\Zip Release\Version-*" | Set-Variable -Name "BUILD_VERSION"
        echo "Set BUILD_VERSION=" ${BUILD_VERSION}
        echo "BUILD_VERSION=${BUILD_VERSION}" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf-8 -Append
        
# Add a new commit for the bump in version number.        
# We add the git pull --ff 

    - name: Commit version change
      run: |
        git config --global user.name 'CI Build'
        git config --global user.email '3Dmigoto@bo3b.net'
        git pull --ff-only
        git commit -am "CI Build - ${{env.BUILD_VERSION}}"
        git push
        
# Now we can upload the remaining artifacts as the HelixMod version.
# These artifacts are for testing, and not actual Releases.

    - name: Upload HelixMod build
      uses: actions/upload-artifact@v4
      with:
        name: 3Dmigoto v${{env.BUILD_VERSION}}
        path: Zip Release\
